version: '3'
output: prefixed
vars:
  # App database for the local dev environment (see tasks start-with-local-pg, apply-migrations-pg)
  XNGIN_DEVAPPDB_NAME: "xngin"
  XNGIN_DEVAPP_DSN: "postgresql://postgres:postgres@localhost:5499/{{.XNGIN_DEVAPPDB_NAME}}?sslmode=disable"

  # Data warehouse available for use by the local dev environment (see task bootstrap-dwh-local-pg). It is bootstrapped
  # with the testing datawarehouse when `task start-with-local-pg` is used. We explicitly specify +psycopg because
  # we want to use an optimized path for CSV loading.
  XNGIN_DEVDWH_NAME: "dwh"
  XNGIN_DEVDWH_DSN: "postgresql+psycopg://postgres:postgres@localhost:5499/{{.XNGIN_DEVDWH_NAME}}?sslmode=disable"

  # Datasource for tests of the xngin app database that use the xngin_db_session dependency.
  XNGIN_TESTAPP_DSN: "postgresql://postgres:postgres@localhost:5499/test_xngin?sslmode=disable"

  # Datasource for the Postgres integration tests run by `task test-pgintegration`.
  # Note: test_queries.py creates a random database name adapting this dsn for each test using its
  # fixture_db_session.
  XNGIN_TESTDWH_DSN: "postgresql://postgres:postgres@localhost:5499/test_dwh?sslmode=disable"
env:
  # Disable Atlas telemetry.
  ATLAS_NO_ANON_TELEMETRY: "true"
  DO_NOT_TRACK: "1"

  # Google will redirect to this URL upon successful authentication. This URL is served by the frontend application
  # and the GoogleAuthProvider component will intercept the query arguments and handle them.
  GOOGLE_OIDC_REDIRECT_URI: "http://localhost:3000/"

  # These values are configured in the xngin-development-dc project and should be used in development environments:
  # https://console.cloud.google.com/apis/credentials?organizationId=256829878972&project=xngin-development-dc.
  GOOGLE_OIDC_CLIENT_ID: "222213100775-qa1ajcrk48il70itcbdcvgr9ib5t08uf.apps.googleusercontent.com"

  # These values are configured in the evidential-live project and should only be used when validating the
  # production environments:
  # https://console.cloud.google.com/auth/clients?project=evidential-live
  #GOOGLE_OIDC_CLIENT_ID: "314428509782-j8fgiq5dvoic01432s2bcu3isinc9kam.apps.googleusercontent.com"
  #GOOGLE_OIDC_REDIRECT_URI: "http://localhost:3000/"

  # These are values used in the xngin.railway.settings.json and are present for when testing the Railway configs.
  # (optional)
  DWH_PGHOST: "127.0.0.1"
  DWH_PGPASSWORD: "pgpass"
  DWH_PGPORT: "5632"
  DWH_PGUSER: "pguser"
  CUSTOMER_API_TOKEN: ""
  CUSTOMER_DWH_PASSWORD: ""

  # Ask SQLAlchemy to print the generated SQL statements.
  ECHO_SQL: "true"

  # Publish the OpenAPI spec for the admin and OIDC APIs
  XNGIN_PUBLISH_ALL_DOCS: "true"

  # Generally useful settings.
  XNGIN_SETTINGS: "src/xngin/apiserver/testdata/xngin.testing.settings.json"
  XNGIN_DEBUG: "true"
tasks:
  start:
    desc: "Starts apiserver locally with settings compatible with local dash dev server (using sqlite)."
    interactive: true
    dotenv:
      # Populate BQ_SERVICE_ACCOUNT (optional) and GOOGLE_OIDC_CLIENT_SECRET (optional).
      - .env
    env:
      # Admin API settings. These need to be set for interaction with the dash web UI.
      # Also see instructions for .env above.
      ENABLE_ADMIN: "true"
      ENABLE_OIDC: "true"

    cmds:
      - uv run fastapi dev src/xngin/apiserver/main.py
  start-with-local-pg:
    desc: "Starts apiserver locally with settings compatible with local dash dev server (using PostgreSQL)"
    interactive: true
    dotenv:
      # Populate BQ_SERVICE_ACCOUNT (optional) and GOOGLE_OIDC_CLIENT_SECRET (optional).
      - .env
    env:
      XNGIN_DB: "{{.XNGIN_DEVAPP_DSN}}"

      # Admin API settings. These need to be set for interaction with the dash web UI.
      # Also see instructions for .env above.
      ENABLE_ADMIN: "true"
      ENABLE_OIDC: "true"
    cmds:
      # Ensure the localpg server is running and has an "xngin" database. If the database doesn't already exist,
      # have Atlas create the tables so that subsequent table migrations behave as expected.
      - >
        ./tools/localpg.py --allow-existing -d --wait --create-db {{.XNGIN_DEVAPPDB_NAME}}
        --if-created "uv run task apply-migrations-pg"
      - task bootstrap-dwh-local-pg || /bin/true
      - uv run fastapi dev src/xngin/apiserver/main.py
  bootstrap-dwh-local-pg:
    desc: "Bootstraps the localpg server with a sample data warehouse."
    interactive: true
    cmds:
      - uv run xngin-cli create-testing-dwh --dsn '{{.XNGIN_DEVDWH_DSN}}' --hacks
  test:
    desc: "Runs unit tests"
    interactive: true
    cmds:
      - uv run pytest
  update-api-tests:
    desc: "Run the API tests and update the expected responses."
    interactive: true
    env:
      UPDATE_API_TESTS: "1"
    cmd: uv run pytest src/xngin/apiserver/test_api.py
  test-pgintegration:
    desc: "Runs unit tests w/local postgres support"
    env:
      XNGIN_TEST_APPDB_URI: "{{.XNGIN_TESTAPP_DSN}}"
      XNGIN_TEST_DWH_URI: "{{.XNGIN_TESTDWH_DSN}}"
    interactive: true
    cmds:
      - ./tools/localpg.py --allow-existing -d --wait --create-db test_xngin
      - uv run pytest -m 'pgintegration or not integration'
  make-migrations:
    desc: "Build Postgres migrations"
    cmds:
      - uv run atlas migrate diff --env sa_postgres && git add migrations
  apply-migrations-pg:
    desc: "Apply Postgres migrations locally (requires localpg instance to be running, to have an xngin database, and to have been previously migrated)"
    cmds:
      - uv run atlas migrate diff --env sa_postgres
      - uv run atlas migrate apply --env sa_postgres --url '{{.XNGIN_DEVAPP_DSN}}'
  apply-migrations-sqlite:
    desc: "Apply sqlite migrations locally"
    cmd: |
      # Generate the migration files to ensure that they are up to date
      uv run atlas migrate diff --env sa_sqlite
      # If the apiserver created the database, there will not be any migration data; therefore, we pass a --baseline
      # flag to get that created.
      sqlite3 xngin.db .tables | grep -q "atlas_schema_revisions" \
        && uv run atlas migrate apply --env sa_sqlite --url sqlite://xngin.db \
        || uv run atlas migrate apply --env sa_sqlite --url sqlite://xngin.db --baseline $(ls -t migrations/sa_sqlite | grep .sql | sort -n | cut -f1 -d. | head -1)
