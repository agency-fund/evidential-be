<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }
        button, input {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Admin UI</h1>

    <div id="not-logged-in">
        <button onclick="login()">Login with Google</button>
    </div>

    <div id="logged-in" style="display: none;">
        <h2>Logged In</h2>
        <button onclick="logout()">Logout</button>
        <br/>
        <button onclick="callProtectedEndpoint('m/caller-identity')">Ping</button>
        <br/>
        <button onclick="callProtectedEndpoint('m/datasources')">List Datasources</button>
        <button onclick="callProtectedEndpoint('m/apikeys')">List API Keys</button>
        <br/>
        <input id="datasource" value="testing-secured"><button onclick="callCreateApiKey()">Create API Key</button>
        <br/>
        <h3>Response:</h3>
        <pre id="response"></pre>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        const OIDC_BASE_URL = 'http://localhost:8000/a/oidc';

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                handleCallback(code);
            }
            updateUI();
        };

        const base64urlEncode = buffer => btoa(String.fromCharCode(...new Uint8Array(buffer)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');

        const generateCodeVerifier = () => {
            const array = new Uint8Array(56);
            crypto.getRandomValues(array);
            return base64urlEncode(array);
        };

        const generateCodeChallenge = async codeVerifier => {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return base64urlEncode(digest);
        };

        async function login() {
            try {
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                sessionStorage.setItem('code_verifier', codeVerifier);
                const response = await fetch(
                    `${OIDC_BASE_URL}/login?code_challenge=${codeChallenge}&code_challenge_method=S256`
                );
                const data = await response.json();
                window.location.href = data.auth_url;
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Check console for details.');
            }
        }

        async function handleCallback(authCode) {
            try {
                window.history.replaceState({}, document.title, window.location.pathname);
                const codeVerifier = sessionStorage.getItem('code_verifier');
                if (!codeVerifier) {
                    throw new Error('No code verifier found');
                }
                const response = await fetch(
                    `${OIDC_BASE_URL}/callback?code=${authCode}&code_verifier=${codeVerifier}`
                );
                const tokens = await response.json();
                localStorage.setItem('id_token', tokens.id_token);
                sessionStorage.removeItem('code_verifier');
                updateUI();
            } catch (error) {
                console.error('Callback error:', error);
                alert('Authentication failed. Check console for details.');
            }
        }

        async function callProtectedEndpoint(path) {
            try {
                const idToken = localStorage.getItem('id_token');
                if (!idToken) {
                    throw new Error('No ID token found');
                }
                const response = await fetch(`${API_URL}/${path}`, {
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });
                const data = await response.json();
                document.getElementById('response').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                console.error('API call error:', error);
                alert('API call failed. Check console for details.');
            }
        }

        async function callCreateApiKey() {
            const datasource = document.getElementById('datasource').value;
            try {
                const idToken = localStorage.getItem('id_token');
                if (!idToken) {
                    throw new Error('No ID token found');
                }
                const response = await fetch(`${API_URL}/m/apikeys`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        datasource_ids: [datasource]
                    })
                });
                const data = await response.json();
                document.getElementById('response').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                console.error('API call error:', error);
                alert('API call failed. Check console for details.');
            }

        }

        function logout() {
            localStorage.removeItem('id_token');
            updateUI();
            document.getElementById('response').textContent = '';
        }

        function updateUI() {
            const idToken = localStorage.getItem('id_token');
            document.getElementById('logged-in').style.display = idToken ? 'block' : 'none';
            document.getElementById('not-logged-in').style.display = idToken ? 'none' : 'block';
        }
    </script>
</body>
</html>
